<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√°n C√¢n C√¥ng L√Ω v3.3: AI To√†n Di·ªán</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Patrick+Hand&family=Dancing+Script:wght@700&display=swap');

        /* 1. C·∫§U TR√öC & N·ªÄN */
        body { margin: 0; padding: 0; overflow: hidden; user-select: none; font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .algebra-font, .box-x, .weight-x, .equation-box, .opt-btn, .notebook-line, .equal-sign, .katex { font-family: 'Times New Roman', serif; font-style: italic; }
        .bg-blue { background: #0984e3; border: 2px solid #0652dd; color: white; }
        .bg-red { background: #d63031; border: 2px solid #c0392b; color: white; }

        /* HI·ªÜU ·ª®NG */
        #rain-container, #lightning, #canvas-fireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        body.storm-mode { background: #2d3436 !important; transition: background 0.5s; }
        .rain-drop { position: absolute; width: 3px; height: 25px; background: rgba(255,255,255,0.7); bottom: 100%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(120vh); } }
        .flash-anim { animation: flash 0.2s infinite; }
        @keyframes flash { 0%, 100% { opacity: 0; background: white; } 50% { opacity: 0.8; } }
        
        /* ANIMATION */
        .flying-container { position: fixed; z-index: 9999; pointer-events: none; transition: transform 3s ease-in-out; margin: 0; }
        .flying-content { display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; font-family: 'Times New Roman', serif; font-style: italic; box-shadow: 0 25px 50px rgba(0,0,0,0.5); animation: parabolicArc 3s forwards, colorFlipAnim 3s forwards; }
        @keyframes parabolicArc { 0% { transform: translateY(0) scale(1); animation-timing-function: ease-out; } 50% { transform: translateY(-180px) scale(1.1); animation-timing-function: ease-in; } 100% { transform: translateY(0) scale(1); animation-timing-function: ease-out; } }
        @keyframes flipB2R { 0%,45%{border-color:#0652dd} 55%,100%{border-color:#c0392b} }
        @keyframes flipR2B { 0%,45%{border-color:#c0392b} 55%,100%{border-color:#0652dd} }
        .flipping-b2r .flying-content { animation-name: parabolicArc, flipB2R; }
        .flipping-r2b .flying-content { animation-name: parabolicArc, flipR2B; }
        @keyframes popScale { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        .merge-pop { animation: popScale 0.5s ease-out; }
        @keyframes shakeBeam { 0%, 100% { transform: rotate(0deg); } 20% { transform: rotate(3deg); } 40% { transform: rotate(-3deg); } 60% { transform: rotate(2deg); } 80% { transform: rotate(-2deg); } }
        .wobble-effect { animation: shakeBeam 0.5s ease-in-out; }
        .balloon { position: absolute; bottom: -100px; width: 40px; height: 50px; border-radius: 50%; z-index: 60; animation: floatUp linear forwards; opacity: 0.8; }
        .balloon::before { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 2px; height: 10px; background: rgba(0,0,0,0.3); }
        @keyframes floatUp { to { transform: translateY(-120vh) rotate(360deg); } }

        /* MODALS */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); transition: opacity 0.3s; }
        #confirm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9000; display: none; justify-content: center; align-items: center; flex-direction: column; animation: fadeIn 0.5s; }
        .confirm-btn { padding: 20px 40px; font-size: 1.5rem; font-weight: 900; color: white; background: #00b894; border: 4px solid white; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.2s; text-transform: uppercase; text-align: center; }
        .confirm-btn:hover { transform: scale(1.1); background: #00a884; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .error-popup { background: white; width: 95%; max-width: 950px; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .error-header { background: #2d3436; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .eh-item { text-align: center; } .eh-label { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; } .eh-val { font-weight: 900; font-size: 1.2rem; }
        .status-bad { color: #ff7675; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .warning-strip { background: #ffeaa7; color: #d63031; text-align: center; padding: 8px; font-weight: 800; font-size: 0.95rem; border-bottom: 1px dashed #b2bec3; text-transform: uppercase; }
        .error-body { display: flex; padding: 20px; gap: 20px; }
        .eb-left { flex: 1; display: flex; flex-direction: column; gap: 15px; } .eb-right { flex: 1.2; display: flex; flex-direction: column; }
        .red-reason-box { background: #ff7675; color: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 0 #d63031; }
        .rrb-title { font-weight: 900; font-size: 1.3rem; text-transform: uppercase; margin-bottom: 5px; }
        .gray-theory-box { background: #f1f2f6; color: #2d3436; border-radius: 10px; padding: 15px; border-left: 5px solid #636e72; }
        .gtb-title { font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .solution-title { text-align: center; color: #2d3436; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 3px solid #0984e3; display: inline-block; align-self: center;}
        .notebook-paper { background: white; border: 1px solid #dfe6e9; border-radius: 8px; box-shadow: 3px 3px 10px rgba(0,0,0,0.1); overflow: hidden; padding-bottom: 10px; }
        .notebook-line { height: 45px; border-bottom: 1px solid #74b9ff; display: flex; align-items: flex-end; padding: 0 20px; font-family: 'Patrick Hand', cursive; font-size: 1.8rem; color: #0984e3; line-height: 1; }
        .error-footer { padding: 15px; text-align: center; background: #f1f2f6; }
        
        /* GAME UI */
        #game-container { background: rgba(255, 255, 255, 0.95); width: 98%; max-width: 1100px; height: 95vh; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; align-items: center; border: 4px solid #fff; z-index: 10; }
        .header-stats { display: flex; justify-content: space-between; width: 90%; margin-top: 20px; font-size: 1.2rem; font-weight: 800; color: #636e72; }
        .integrity-badge { color: #6c5ce7; background: #f1f2f6; padding: 5px 15px; border-radius: 20px; border: 2px solid #a29bfe; }
        .game-title-banner { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 2.2rem; color: #2d3436; text-transform: uppercase; margin: 10px 0; text-align: center; border-bottom: 3px solid #dfe6e9; padding-bottom: 5px; width: 80%; }
        .scale-area { flex-grow: 1; width: 100%; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .equal-sign { position: absolute; top: 35%; left: 50%; transform: translateX(-50%); font-size: 5rem; font-weight: 900; color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); z-index: 15; }
        .beam { width: 70%; height: 12px; background: #2d3436; border-radius: 10px; position: relative; transition: transform 0.5s; z-index: 10; }
        .fulcrum { width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 50px solid #2d3436; margin-top: -5px; z-index: 5; }
        .pan { position: absolute; top: 100%; width: 160px; height: 8px; background: #2d3436; border-radius: 4px; }
        .pan::before, .pan::after { content: ''; position: absolute; width: 3px; height: 90px; background: #b2bec3; top: -90px; }
        .pan::before { left: 10px; } .pan::after { right: 10px; } .pan.left { left: 0; } .pan.right { right: 0; }
        .items-container { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; align-items: flex-end; gap: 5px; }
        .weight, .box-x { display: flex; justify-content: center; align-items: center; font-weight: bold; z-index: 2; transition: all 0.5s; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .weight { width: 45px; height: 45px; border-radius: 50%; font-size: 1.1rem; }
        .box-x { font-size: 2rem; border-radius: 8px; font-family: 'Times New Roman', serif; font-style: italic; }
        .size-1 { width: 50px; height: 50px; font-size: 1.5rem; } .size-2 { width: 70px; height: 70px; font-size: 2.2rem; } .size-3 { width: 90px; height: 90px; font-size: 2.8rem; }
        .qa-section { width: 100%; text-align: center; padding-bottom: 20px; z-index: 50; position: relative; }
        .equation-box { font-size: 2.5rem; font-weight: 900; color: #2d3436; background: #dfe6e9; padding: 10px 40px; border-radius: 15px; display: inline-block; margin-bottom: 15px; border-bottom: 5px solid #b2bec3; }
        .options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 90%; max-width: 600px; margin: 0 auto; }
        .opt-btn { background: white; padding: 15px; border: 3px solid #dfe6e9; border-radius: 15px; font-size: 1.8rem; font-weight: 800; color: #636e72; cursor: pointer; transition: all 0.2s; font-family: 'Times New Roman', serif; font-style: italic; }
        .opt-btn:hover { transform: translateY(-3px); border-color: #74b9ff; }
        .opt-btn.correct { background: #00b894 !important; color: white !important; border-color: #00cec9 !important; animation: pulse 0.5s; }
        .opt-btn.wrong { background: #ff7675; color: white; border-color: #d63031; opacity: 0.6; }
        #cheat-btn { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: #ffeaa7; border: 2px solid #fdcb6e; color: #d35400; font-weight: bold; padding: 10px 15px; border-radius: 10px; cursor: pointer; }
        #timer-bar { height: 10px; width: 100%; background: linear-gradient(90deg, #00b894, #00cec9); transition: width 1s linear; border-radius: 5px; }
        .timer-container { width: 100%; background: #dfe6e9; height: 10px; border-radius: 5px 5px 0 0; }

        /* REPORT CARD */
        #outro-screen { background: #dfe6e9; display: none; opacity: 0; overflow-y: auto; padding: 20px 0; }
        .report-container { background: white; width: 96%; max-width: 1100px; min-height: 85vh; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .rc-header { background: linear-gradient(90deg, #6c5ce7, #a29bfe); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .rc-info-group { display: flex; flex-direction: column; }
        .rc-student-name { font-size: 1.6rem; font-weight: 900; text-transform: uppercase; }
        .rc-score-group { display: flex; gap: 20px; text-align: center; }
        .rc-score-val { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        .integrity-val { color: #ffeaa7; text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }
        .rc-body { padding: 20px; display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; flex: 1; overflow-y: auto; }
        .card { border-radius: 10px; padding: 15px; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .card-title { font-weight: 900; text-transform: uppercase; display: flex; align-items: center; gap: 5px; border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 5px; margin-bottom: 5px; font-size: 1rem; }
        .method-card { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; flex: 1; overflow-y: auto; max-height: 400px; }
        .pedagogy-detail p { margin: 8px 0; line-height: 1.5; }
        .ped-header { font-weight: 900; text-transform: uppercase; color: #00cec9; border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 2px; margin-bottom: 5px; display: inline-block; }
        .ped-highlight { color: #d63031; font-weight: bold; background: #ffeaa7; padding: 0 5px; border-radius: 3px; }
        .homework-card { background: white; border: 2px solid #6c5ce7; color: #2d3436; display: flex; flex-direction: column; flex: 1; }
        .hw-answer { color: #00b894; font-weight: bold; font-style: italic; display: none; }
        .hw-answer.show { display: block; }
        .rc-footer { padding: 15px; background: #f1f2f6; text-align: center; display: flex; justify-content: flex-start; gap: 15px; padding-bottom: 150px; }
        .btn { background: #e17055; color: white; border: none; padding: 10px 25px; font-size: 1.1rem; font-weight: 800; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #d35400; transition: transform 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: #00b894; box-shadow: 0 5px 0 #00a884; }
        .hw-toggle-btn { background:#6c5ce7; color:white; border:none; padding:2px 8px; border-radius:4px; cursor:pointer; transition: background 0.2s; }
        .hw-toggle-btn:hover { background: #5b4bc4; }

        /* CHATBOT & INPUTS */
        #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
        #chat-toggle { width: 60px; height: 60px; border-radius: 50%; background: #6c5ce7; color: white; border: none; font-size: 30px; cursor: pointer; }
        #chat-window { width: 320px; height: 420px; background: white; border-radius: 15px; display: none; flex-direction: column; border: 1px solid #ccc; margin-bottom: 10px; }
        #chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #f5f6fa; }
        .msg { padding: 8px; border-radius: 10px; margin-bottom: 5px; max-width: 80%; font-size: 0.9rem; }
        .input-group { display: flex; flex-direction: column; gap: 10px; width: 60%; max-width: 350px; margin: 20px 0; }
        .name-input { padding: 10px 15px; font-size: 1rem; border-radius: 25px; border: 2px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.2); color: white; text-align: center; outline: none; }
        .cheat-popup { background: white; width: 90%; max-width: 500px; border-radius: 10px; overflow: hidden; text-align: center; }
        
        @media (max-width: 768px) { .rc-body, .error-body { grid-template-columns: 1fr; flex-direction: column; } }
    </style>
</head>
<body>
    <div id="rain-container"></div><div id="lightning"></div><canvas id="canvas-fireworks"></canvas>

    <div id="confirm-overlay">
        <button class="confirm-btn" onclick="handleUserConfirmed()">EM ƒê√É HI·ªÇU ƒê∆Ø·ª¢C QUY T·∫ÆC<br>CHUY·ªÇN V·∫æ ƒê·ªîI D·∫§U</button>
    </div>

    <div id="chat-widget">
        <div id="chat-window">
            <div style="padding:10px; background:#6c5ce7; color:white; font-weight:bold; display:flex; justify-content:space-between;">
                <span>üéì Tr·ª£ L√Ω H·ªó Tr·ª£</span><span style="cursor:pointer" onclick="toggleChat()">‚úñ</span>
            </div>
            <div id="chat-body"><div class="msg bot">Ch√†o em! Th·∫ßy l√† tr·ª£ l√Ω ·∫£o c·ªßa th·∫ßy Th√¥ng (h∆°n 15 nƒÉm kinh nghi·ªám).</div></div>
            <div style="padding:10px; display:flex; gap:5px;">
                <input type="text" id="chat-input" style="flex:1; padding:5px;" placeholder="H·ªèi th·∫ßy..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" style="background:#6c5ce7; color:white; border:none; padding:5px 10px; cursor:pointer;">G·ª≠i</button>
            </div>
        </div>
        <button id="chat-toggle" onclick="toggleChat()">ü§ñ</button>
    </div>

    <div id="intro-screen" class="overlay">
        <h1 style="color:white; font-size:2.5rem; text-shadow: 2px 2px 0 rgba(0,0,0,0.2);">‚öñÔ∏è C√ÅN C√ÇN C√îNG L√ù</h1>
        <p style="color:white;">Xanh = D∆∞∆°ng (+), ƒê·ªè = √Çm (-). Li√™m ch√≠nh l√† S·ª©c m·∫°nh.</p>
        <div class="input-group">
            <input type="text" id="inp-name" class="name-input" placeholder="H·ªç v√† T√™n" autocomplete="off">
            <input type="text" id="inp-class" class="name-input" placeholder="L·ªõp" autocomplete="off">
            <input type="text" id="inp-school" class="name-input" placeholder="Tr∆∞·ªùng" autocomplete="off">
        </div>
        <button class="btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="game-container">
        <div class="timer-container"><div id="timer-bar"></div></div>
        <div style="position:absolute; top:15px; right:20px; font-weight:900; font-size:1.5rem;" id="timer-text">20</div>
        <div class="header-stats">
            <span>C√ÇU: <span id="lvl-disp">1</span>/10</span>
            <span class="integrity-badge">üòá <span id="int-disp">100</span>%</span>
            <span>ƒêI·ªÇM: <span id="score-disp">0</span></span>
        </div>
        <div class="game-title-banner">C√ÅN C√ÇN C√îNG L√ù</div>
        <div class="scale-area">
            <div class="equal-sign">=</div>
            <div class="beam" id="beam">
                <div class="pan left" id="pan-left"><div class="items-container" id="left-items"></div></div>
                <div class="pan right" id="pan-right"><div class="items-container" id="right-items"></div></div>
            </div>
            <div class="fulcrum"></div>
        </div>
        <div class="qa-section">
            <button id="cheat-btn" onclick="useCheat()">üëÅÔ∏è Xem ƒê√°p √Ån</button>
            <div class="equation-box" id="eq-text">...</div>
            <div class="options" id="opts-area"></div>
        </div>
    </div>

    <div id="cheat-modal" class="overlay" style="display:none;">
        <div class="cheat-popup">
            <div class="cheat-header" style="background:#d63031; color:white;">‚ö†Ô∏è C·∫¢NH B√ÅO L∆Ø∆†NG T√ÇM</div>
            <div style="padding:20px;">
                <p>ƒê√°p √°n l√†:</p><div style="font-size:2rem; color:#6c5ce7; margin:10px 0;" id="cheat-val">x = ...</div>
                <p style="color:#d63031; font-weight:bold;">Tr·ª´ 20% Li√™m ch√≠nh!</p>
                <button class="btn" onclick="closeCheat()">EM ƒê√É HI·ªÇU</button>
            </div>
        </div>
    </div>

    <div id="explain-modal" class="overlay" style="display:none;">
        <div class="error-popup">
            <div class="error-header">
                <div class="eh-item"><div class="eh-label">ƒêI·ªÇM HI·ªÜN T·∫†I</div><div class="eh-val"><span id="pop-score">0</span>/10</div></div>
                <div class="eh-item"><div class="eh-label">LI√äM CH√çNH</div><div class="eh-val" style="color:#6c5ce7"><span id="pop-int">100</span>%</div></div>
                <div class="eh-item"><div class="eh-label">C√íN L·∫†I</div><div class="eh-val"><span id="pop-remain">9</span></div></div>
                <div class="eh-item"><div class="eh-label">TR·∫†NG TH√ÅI</div><div class="eh-val status-bad">‚ö†Ô∏è SAI</div></div>
            </div>
            <div class="warning-strip">L∆ØU √ù: TR∆Ø·ªöC M·ªñI D√íNG KH√îNG ƒê∆Ø·ª¢C GHI D·∫§U "=", PH·∫¢I C√ì CH·ªÆ "x" ·ªû M·ªñI D√íNG!</div>
            <div class="error-body">
                <div class="eb-left">
                    <div class="red-reason-box">
                        <div class="rrb-title">T·∫†I SAO SAI?</div>
                        <div class="rrb-content" id="err-reason">...</div>
                    </div>
                    <div class="gray-theory-box">
                        <div class="gtb-title">L√ù THUY·∫æT C·∫¶N NH·ªö</div>
                        <div id="err-hint">...</div>
                    </div>
                </div>
                <div class="eb-right">
                    <div class="solution-title">L·ªúI GI·∫¢I T·ª∞ LU·∫¨N CHU·∫®N</div>
                    <div class="notebook-paper" id="std-solution"></div>
                </div>
            </div>
            <div class="error-footer"><button class="btn" onclick="nextLevel()">EM ƒê√É NH·∫¨N RA L·ªñI SAI. EM XIN PH√âP ƒê∆Ø·ª¢C CH∆†I TI·∫æP ·∫†!</button></div>
        </div>
    </div>

    <div id="outro-screen" class="overlay">
        <div class="report-container" id="printable-report">
            <div class="rc-header">
                <div class="rc-info-group">
                    <div class="rc-student-name" id="rp-name">...</div>
                    <div style="opacity:0.9" id="rp-detail">...</div>
                </div>
                <div class="rc-score-group">
                    <div><div style="font-size:0.8rem; opacity:0.8">TR√ç TU·ªÜ</div><div class="rc-score-val" id="rp-score">0/10</div></div>
                    <div><div style="font-size:0.8rem; opacity:0.8">LI√äM CH√çNH</div><div class="rc-score-val integrity-val" id="rp-integrity">100%</div></div>
                </div>
            </div>
            <div class="rc-body">
                <div class="rc-col-left" style="display:flex; flex-direction:column; gap:15px;">
                    <div style="text-align:center; background:#f1f2f6; padding:10px; border-radius:8px; font-family:'Dancing Script'; font-size:1.3rem; color:#6c5ce7; line-height:1.4;" id="rp-quote">...</div>
                    <div class="card method-card">
                        <div class="card-title">üíä C·∫®M NANG PH∆Ø∆†NG PH√ÅP</div>
                        <div id="rp-method" class="pedagogy-detail">...</div>
                    </div>
                </div>
                <div class="rc-col-right" style="display:flex; flex-direction:column; gap:15px;">
                    <div class="card" style="background:#f8f9fa; border:1px solid #dfe6e9;">
                        <div class="card-title">V√ç D·ª§ M·∫™U</div>
                        <div class="notebook-paper" id="rp-model"></div>
                    </div>
                    <div class="card homework-card">
                        <div class="card-title" style="color:#6c5ce7; justify-content:space-between;">
                            <span>üìù B√ÄI T·∫¨P</span>
                            <button class="hw-toggle-btn" onclick="toggleAllAnswers()">ƒê√ÅP √ÅN</button>
                        </div>
                        <ul class="hw-list" id="rp-hw-list" style="list-style:none; padding:0; overflow-y:auto;"></ul>
                    </div>
                </div>
            </div>
            <div class="rc-footer" data-html2canvas-ignore="true">
                <button class="btn btn-green" id="download-btn" onclick="downloadReport()">üì∏ L∆ØU PHI·∫æU ƒêI·ªÇM</button>
                <button class="btn" onclick="location.reload()">CH∆†I L·∫†I</button>
            </div>
        </div>
    </div>

    <script>
        let student = { name: "Nh√† To√°n H·ªçc", class: "...", school: "..." };
        let state = { level: 1, score: 0, integrity: 100, q: {}, timer: null, isBusy: false, errStats: {sign:0, calc:0}, lastUserAns: null, lastResult: false, lastDetailedError: null, lastTheoryHint: null };
        const MAX_LEVEL = 10;

        const wisdom = {
            cheat: ["<b>C·∫≠u b√© chƒÉn c·ª´u:</b> N√≥i d·ªëi nhi·ªÅu s·∫Ω kh√¥ng ai tin. H√£y trung th·ª±c!", "<b>Danh ng√¥n:</b> 'M·∫•t ti·ªÅn l√† m·∫•t √≠t, m·∫•t danh d·ª± l√† m·∫•t t·∫•t c·∫£'.", "<b>C√¢y kim trong b·ªçc:</b> S·ª± gian d·ªëi r·ªìi s·∫Ω b·ªã l·ªô. H√£y d≈©ng c·∫£m!"],
            low: ["<b>R√πa v√† Th·ªè:</b> Ch·∫≠m m√† ch·∫Øc th·∫Øng nhanh m√† ·∫©u. Ki√™n tr√¨ l√™n!", "<b>Ki·∫øn tha l√¢u ƒë·∫ßy t·ªï:</b> C·ªë g·∫Øng t·ª´ng ch√∫t m·ªôt, th√†nh c√¥ng s·∫Ω ƒë·∫øn.", "<b>Th·∫•t b·∫°i l√† m·∫π th√†nh c√¥ng:</b> Sai l·∫ßm l√† b√†i h·ªçc qu√Ω gi√°."],
            high: ["<b>L√∫a ch√≠n c√∫i ƒë·∫ßu:</b> C√†ng gi·ªèi c√†ng khi√™m t·ªën.", "<b>V√†ng th·∫≠t kh√¥ng s·ª£ l·ª≠a:</b> ƒêi·ªÉm s·ªë cao v√† Li√™m ch√≠nh l√† t√†i s·∫£n qu√Ω gi√°."]
        };

        const AudioSys = {
            ctx: null, init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended') this.ctx.resume(); },
            playTone: function(freq, type, dur) { if(!this.ctx) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq, this.ctx.currentTime); g.gain.setValueAtTime(0.1, this.ctx.currentTime); g.gain.linearRampToValueAtTime(0, this.ctx.currentTime+dur); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+dur); },
            playThunder: function() { this.safePlay(ctx=>{ const o=ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(50,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(10,ctx.currentTime+2); const g=ctx.createGain(); g.gain.setValueAtTime(0.8,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+2); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+2); }); },
            playMerge: function() { this.safePlay(ctx=>{ const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(100,ctx.currentTime); o.frequency.linearRampToValueAtTime(300,ctx.currentTime+0.2); const g=ctx.createGain(); g.gain.setValueAtTime(0.2,ctx.currentTime); g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.2); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.2); }); },
            safePlay: function(fn) { if(this.ctx && this.ctx.state!=='closed') { if(this.ctx.state==='suspended') this.ctx.resume(); fn(this.ctx); } }
        };

        function renderMath(text) {
            return text.replace(/\$(.*?)\$/g, (match, math) => {
                try { return katex.renderToString(math, { throwOnError: false }); } catch (e) { return match; }
            });
        }

        function createHeavyRain() { const c = document.getElementById('rain-container'); c.innerHTML = ''; for(let i=0; i<200; i++) { const d = document.createElement('div'); d.className = 'rain-drop'; d.style.left = Math.random()*100+'vw'; d.style.animationDuration = (Math.random()*0.3+0.2)+'s'; d.style.animationDelay = Math.random()+'s'; c.appendChild(d); }}
        const canvas = document.getElementById('canvas-fireworks'); const ctx = canvas.getContext('2d'); let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; } window.addEventListener('resize', resizeCanvas); resizeCanvas();
        function createParticles(x, y) { for(let i=0; i<50; i++) particles.push({x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:100, color:`hsl(${Math.random()*360},100%,50%)`}); }
        function animateFireworks() { ctx.clearRect(0,0,canvas.width,canvas.height); for(let i=0; i<particles.length; i++) { let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life--; p.vy+=0.1; ctx.fillStyle=p.color; ctx.fillRect(p.x, p.y, 4, 4); if(p.life<=0) {particles.splice(i,1); i--;}} requestAnimationFrame(animateFireworks); } animateFireworks();
        function spawnBalloons() { for(let i=0; i<15; i++) { const b = document.createElement('div'); b.className = 'balloon'; b.style.left = Math.random()*90+'vw'; b.style.background = `hsl(${Math.random()*360},70%,60%)`; b.style.animationDuration = (Math.random()*2+3)+'s'; document.body.appendChild(b); setTimeout(()=>b.remove(), 5000); }}
        function triggerCelebration() { createParticles(window.innerWidth/2, window.innerHeight/2); createParticles(window.innerWidth/3, window.innerHeight/3); createParticles(2*window.innerWidth/3, window.innerHeight/3); spawnBalloons(); }

        function startGame() {
            AudioSys.init();
            const n=document.getElementById('inp-name').value.trim(), c=document.getElementById('inp-class').value.trim(), s=document.getElementById('inp-school').value.trim();
            if(n) student.name=n; if(c) student.class=c; if(s) student.school=s;
            document.getElementById('intro-screen').style.opacity=0; setTimeout(()=>{ document.getElementById('intro-screen').style.display='none'; nextQuestion(); },300);
        }

        function nextQuestion() {
            state.isBusy = false; 
            const beam = document.getElementById('beam');
            beam.style.transform="rotate(0deg)"; 
            beam.classList.remove('wobble-effect'); 

            document.getElementById('rain-container').style.display='none'; document.body.classList.remove('storm-mode');
            document.getElementById('lvl-disp').innerText = state.level; document.getElementById('score-disp').innerText = state.score; document.getElementById('int-disp').innerText = state.integrity;
            state.lastDetailedError = null;
            if(state.level<=5) {
                let a=randNZ(-10,10), x=randNZ(-10,10), b=x+a;
                state.q = { type:'basic', a:a, x:x, b:b, eq:`x ${fmt(a)} = ${b}` };
            } else {
                let c1=randNZ(-5,5), c2=randNZ(-5,5); while(c1===c2) c2=randNZ(-5,5);
                let x=randNZ(-10,10), a=randNZ(-10,10), b=(c1-c2)*x+a;
                state.q = { type:'adv', c1:c1, c2:c2, a:a, b:b, x:x, eq:`${fmtX(c1)}x ${fmt(a)} = ${fmtX(c2)}x ${fmt(b)}` };
            }
            renderGame(); startTimer();
        }

        function renderGame() {
            const q = state.q;
            document.getElementById('left-items').innerHTML = (q.type==='basic') ? htmlW('x',1)+htmlW('n',q.a) : htmlW('x',q.c1)+htmlW('n',q.a);
            document.getElementById('right-items').innerHTML = (q.type==='basic') ? htmlW('n',q.b) : htmlW('x',q.c2)+htmlW('n',q.b);
            document.getElementById('eq-text').innerHTML = q.eq;
            const o = document.getElementById('opts-area'); o.innerHTML='';
            let arr=[q.x]; while(arr.length<4){let r=q.x+randNZ(-5,5); if(!arr.includes(r)) arr.push(r);}
            arr.sort(()=>Math.random()-0.5).forEach(v=>{
                let b=document.createElement('button'); b.className='opt-btn'; b.innerHTML=`x = ${v}`; b.onclick=()=>submitAns(v,b); o.appendChild(b);
            });
        }

        function startTimer() { clearInterval(state.timer); let t=20; const b=document.getElementById('timer-bar'); b.style.width="100%"; b.className=""; state.timer=setInterval(()=>{ t--; document.getElementById('timer-text').innerText=t; b.style.width=(t/20*100)+"%"; if(t<=5) b.className="bg-red"; if(t<=0) { clearInterval(state.timer); submitAns(null,null); } },1000); }

        function submitAns(val, btn) {
            if(state.isBusy) return; state.isBusy=true; clearInterval(state.timer);
            state.lastUserAns = val; const isRight = (val === state.q.x); state.lastResult = isRight;
            
            if(isRight) { 
                if(btn) btn.classList.add('correct'); AudioSys.playTone(600,'sine',0.5); state.score++; triggerCelebration(); 
            } else { 
                if(btn) btn.classList.add('wrong');
                document.getElementById('beam').classList.add('wobble-effect');

                if(val === null) {
                    state.errStats.calc++;
                    state.lastDetailedError = "Em ƒë√£ h·∫øt th·ªùi gian. H√£y c·ªë g·∫Øng t√≠nh to√°n nhanh h∆°n m·ªôt ch√∫t nh√©!";
                    state.lastTheoryHint = "H√£y t·∫≠p trung cao ƒë·ªô ƒë·ªÉ ph·∫£n x·∫° nhanh h∆°n nh√©.";
                } else if(val === -state.q.x) {
                    state.errStats.sign++;
                    state.lastDetailedError = `Em b·ªã sai d·∫•u r·ªìi. Khi chuy·ªÉn v·∫ø, nh·ªõ ph·∫£i ƒë·ªïi d·∫•u nh√©! (K·∫øt qu·∫£ ƒë√∫ng l√† ${state.q.x}, kh√¥ng ph·∫£i ${val})`;
                    state.lastTheoryHint = "Quy t·∫Øc v√†ng: Chuy·ªÉn v·∫ø $\\rightarrow$ ƒê·ªïi d·∫•u.";
                } else if(state.q.type === 'basic' && val === state.q.b + state.q.a) {
                    state.errStats.sign++;
                    state.lastDetailedError = `Em chuy·ªÉn v·∫ø ${fmt(state.q.a)} nh∆∞ng qu√™n ƒë·ªïi d·∫•u.`;
                    state.lastTheoryHint = `Khi chuy·ªÉn ${state.q.a > 0 ? '+' : ''}${state.q.a} sang v·∫ø ph·∫£i, n√≥ ph·∫£i bi·∫øn th√†nh ${state.q.a > 0 ? '-' : '+'}${Math.abs(state.q.a)}.`;
                } else {
                    state.errStats.calc++;
                    if(state.q.type === 'basic') {
                         state.lastDetailedError = `C√≥ v·∫ª em t√≠nh nh·∫ßm ph√©p t√≠nh: ${state.q.b} ${state.q.a > 0 ? '-' : '+'} ${Math.abs(state.q.a)}. H√£y ki·ªÉm tra l·∫°i nh√©.`;
                         state.lastTheoryHint = "C·ªông hai s·ªë nguy√™n c√πng d·∫•u: C·ªông tr·ªã tuy·ªát ƒë·ªëi, gi·ªØ nguy√™n d·∫•u.\nC·ªông hai s·ªë nguy√™n kh√°c d·∫•u: Tr·ª´ tr·ªã tuy·ªát ƒë·ªëi (l·ªõn - b√©), l·∫•y d·∫•u c·ªßa s·ªë l·ªõn.";
                    } else {
                        state.lastDetailedError = "Em h√£y c·∫©n th·∫≠n khi gom c√°c s·ªë h·∫°ng ch·ª©a x v·ªÅ m·ªôt v·∫ø.";
                        state.lastTheoryHint = "Nh·ªõ r·∫±ng: $x$ ƒë·ª©ng m·ªôt m√¨nh nghƒ©a l√† $1x$. V√≠ d·ª•: $3x - x = 2x$ (ch·ª© kh√¥ng ph·∫£i $3$).";
                    }
                }
                
                setTimeout(() => {
                     document.body.classList.add('storm-mode'); document.getElementById('rain-container').style.display='block'; createHeavyRain(); document.getElementById('lightning').classList.add('flash-anim'); AudioSys.playThunder(); 
                }, 500);
            }
            setTimeout(() => { if(!isRight) document.getElementById('lightning').classList.remove('flash-anim'); runVisualSolver(); }, 1500); 
        }

        function runVisualSolver() {
            const q = state.q;
            const numL = document.querySelector('#left-items .weight'); const numR = document.querySelector('#right-items .weight');
            if(numL) { animateParabolicMerge(numL, numR, true, false, () => { const res = q.b - q.a; if(numR) { numR.className = `weight ${res>=0?'bg-blue':'bg-red'} merge-pop`; numR.innerHTML = res >= 0 ? `+${res}` : `${res}`; } numL.style.opacity = 0; }); }
            if(q.type === 'adv') {
                const xR = document.querySelector('#right-items .box-x'); const xL = document.querySelector('#left-items .box-x');
                setTimeout(() => { if(xR) { animateParabolicMerge(xR, xL, true, true, () => { const resC = q.c1 - q.c2; if(xL) { let size = 'size-1'; if(Math.abs(resC)>=3) size='size-2'; if(Math.abs(resC)>=6) size='size-3'; xL.className = `box-x ${resC>=0?'bg-blue':'bg-red'} ${size} merge-pop`; let txt = Math.abs(resC)===1 ? (resC<0?'-x':'x') : `${resC}x`; xL.innerHTML = txt; } xR.style.opacity = 0; }); } }, 3100);
            }
            const totalWait = (q.type === 'adv') ? 6500 : 3500; setTimeout(() => { document.getElementById('confirm-overlay').style.display = 'flex'; }, totalWait);
        }

        function handleUserConfirmed() {
            document.getElementById('confirm-overlay').style.display = 'none';
            if(state.lastResult) { state.level++; if(state.level>MAX_LEVEL) generateReportCard(); else nextQuestion(); }
            else { showExplain(state.lastUserAns); }
        }

        function animateParabolicMerge(elStart, elTarget, flipSign, isX, onFinish) {
            if(!elStart || !elTarget) return;
            const rectS = elStart.getBoundingClientRect(); const rectT = elTarget.getBoundingClientRect();
            const container = document.createElement('div'); container.className = "flying-container";
            container.style.left = rectS.left + 'px'; container.style.top = rectS.top + 'px';
            container.style.width = elStart.offsetWidth + 'px'; container.style.height = elStart.offsetHeight + 'px';
            
            const content = elStart.cloneNode(true); 
            content.className = "flying-content " + elStart.className.replace('merge-pop',''); 
            content.style.margin = 0;
            
            if(flipSign) { if(content.classList.contains('bg-blue')) container.classList.add('flipping-b2r'); else container.classList.add('flipping-r2b'); }
            
            container.appendChild(content); document.body.appendChild(container); elStart.style.opacity = 0;
            const deltaX = rectT.left - rectS.left; const deltaY = rectT.top - rectS.top;
            container.getBoundingClientRect(); container.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            
            if(flipSign) { 
                setTimeout(() => { 
                    let txt = content.innerText;
                    if(isX) { 
                        if(txt.startsWith('-')) content.innerText = txt.substring(1); else content.innerText = "-" + txt; 
                    } else { 
                        if(txt.includes('+')) content.innerText = txt.replace('+','-'); else if(txt.includes('-')) content.innerText = txt.replace('-','+'); else content.innerText = content.classList.contains('bg-blue') ? `-${txt}` : `+${txt}`; 
                    }
                    if (content.classList.contains('bg-blue')) { content.classList.remove('bg-blue'); content.classList.add('bg-red'); } 
                    else if (content.classList.contains('bg-red')) { content.classList.remove('bg-red'); content.classList.add('bg-blue'); }
                }, 1500);
            }
            setTimeout(() => { AudioSys.playMerge(); container.style.opacity = 0; if(onFinish) onFinish(); setTimeout(() => container.remove(), 300); }, 3000);
        }

        function showExplain(val) {
            const m = document.getElementById('explain-modal');
            const r = document.getElementById('err-reason'), h = document.getElementById('err-hint'), std = document.getElementById('std-solution');
            const q = state.q;
            
            if(val===null) { r.innerText="H·∫æT GI·ªú!"; }
            else if(Math.abs(val)===Math.abs(q.x)) { r.innerText="SAI D·∫§U!"; }
            else { r.innerText="T√çNH TO√ÅN SAI!"; }
            
            h.innerHTML = renderMath(state.lastTheoryHint || "Ki·ªÉm tra l·∫°i ph√©p t√≠nh nh√©.");

            document.getElementById('pop-score').innerText = state.score;
            document.getElementById('pop-int').innerText = state.integrity + "%";
            document.getElementById('pop-remain').innerText = (MAX_LEVEL - state.level); 
            let html = `<div class="notebook-line">${q.eq.replace(/<[^>]*>/g,'')}</div>`;
            if(q.type==='basic') html += `<div class="notebook-line">x = ${q.b} ${q.a>=0?'-':'+'} ${Math.abs(q.a)}</div><div class="notebook-line">x = ${q.x}</div>`;
            else html += `<div class="notebook-line">${fmtX(q.c1-q.c2)}x = ${q.b-q.a}</div><div class="notebook-line">x = ${q.x}</div>`;
            html += `<div class="notebook-line" style="color:#d63031; font-weight:bold;">V·∫≠y S = {${q.x}}</div>`;
            std.innerHTML = html; m.style.display='flex'; setTimeout(()=>m.style.opacity=1,50);
        }

        function nextLevel() {
            document.getElementById('explain-modal').style.opacity=0;
            setTimeout(()=>{ document.getElementById('explain-modal').style.display='none'; state.level++; if(state.level>MAX_LEVEL) generateReportCard(); else nextQuestion(); }, 300);
        }

        function generateReportCard() {
            const s=state.score, i=state.integrity;
            document.getElementById('rp-name').innerText = student.name;
            document.getElementById('rp-detail').innerText = `L·ªõp: ${student.class} | Tr∆∞·ªùng: ${student.school}`;
            document.getElementById('rp-score').innerText = `${s}/10`; document.getElementById('rp-integrity').innerText = `${i}%`;
            let advice = "";
            if(i < 80) advice = wisdom.cheat[Math.floor(Math.random()*wisdom.cheat.length)];
            else if(s < 5) advice = wisdom.low[Math.floor(Math.random()*wisdom.low.length)];
            else advice = wisdom.high[Math.floor(Math.random()*wisdom.high.length)];
            document.getElementById('rp-quote').innerHTML = advice;
            let type = (state.errStats.sign > state.errStats.calc) ? "SIGN" : "CALC"; if(s >= 9) type = "ADV";
            const content = getPedagogy(type);
            document.getElementById('rp-method').innerHTML = renderMath(content.meth);
            document.getElementById('rp-model').innerHTML = content.mod;
            genHW(type);
            const out = document.getElementById('outro-screen'); out.style.display='flex'; setTimeout(()=>out.style.opacity=1,100);
        }

        function getPedagogy(type) {
            if(type === "SIGN") return { meth: `<div class="pedagogy-section"><div class="ped-header">1. KI·∫æN TH·ª®C C·ªêT L√ïI</div><p>Quy t·∫Øc chuy·ªÉn v·∫ø: Khi chuy·ªÉn m·ªôt s·ªë h·∫°ng t·ª´ v·∫ø n√†y sang v·∫ø kia, ta ph·∫£i <span class="ped-highlight">ƒê·ªîI D·∫§U</span> s·ªë h·∫°ng ƒë√≥.</p><div class="ped-header">3. PH∆Ø∆†NG PH√ÅP GI·∫¢I</div><p>B1: X√°c ƒë·ªãnh s·ªë c·∫ßn chuy·ªÉn. B2: Chuy·ªÉn sang v·∫ø kia v√† ƒë·ªïi d·∫•u. B3: T√≠nh to√°n.</p></div>`, mod: `<div class="notebook-line">x + 5 = 2</div><div class="notebook-line">x = 2 - 5</div><div class="notebook-line">x = -3</div><div class="notebook-line" style="color:red">V·∫≠y S={-3}</div>` };
            else if (type === "CALC") return { meth: `<div class="pedagogy-section"><div class="ped-header">1. KI·∫æN TH·ª®C C·ªêT L√ïI</div><p>Quy t·∫Øc c·ªông tr·ª´ s·ªë nguy√™n: C√πng d·∫•u c·ªông tr·ªã, gi·ªØ d·∫•u. Kh√°c d·∫•u tr·ª´ tr·ªã, l·∫•y d·∫•u s·ªë l·ªõn.</p><div class="ped-header">2. PH∆Ø∆†NG PH√ÅP TR√ÅNH SAI</div><p>Nh·∫©m d·∫•u tr∆∞·ªõc, nh·∫©m s·ªë sau.</p></div>`, mod: `<div class="notebook-line">x - 3 = -10</div><div class="notebook-line">x = -10 + 3</div><div class="notebook-line">x = -7</div><div class="notebook-line" style="color:red">V·∫≠y S={-7}</div>` };
            else return { meth: `<div class="pedagogy-section"><div class="ped-header">N√ÇNG CAO: HAI V·∫æ C√ì X</div><p>D·∫°ng: $ax + b = cx + d$. C√°ch gi·∫£i: Chuy·ªÉn h·∫øt $x$ sang tr√°i, s·ªë sang ph·∫£i.</p></div>`, mod: `<div class="notebook-line">3x = x - 8</div><div class="notebook-line">2x = -8</div><div class="notebook-line">x = -4</div><div class="notebook-line" style="color:red">V·∫≠y S={-4}</div>` };
        }

        function genHW(t) {
            const l = document.getElementById('rp-hw-list'); l.innerHTML='';
            for(let i=1; i<=5; i++) {
                let qT, ans, a=randNZ(-10,10), x=randNZ(-10,10); let b = x+a; qT=`x ${fmt(a)} = ${b}`; ans=x;
                let li=document.createElement('li'); li.style.padding="10px"; li.style.borderBottom="1px dashed #ccc";
                li.innerHTML=`<b>B√†i ${i}:</b> T√¨m x bi·∫øt ${qT} <br> <span class="hw-answer">ƒêS: x=${ans}</span>`; l.appendChild(li);
            }
        }

        function randNZ(min,max) { let v=0; while(v===0) v=Math.floor(Math.random()*(max-min+1))+min; return v; }
        function fmt(n) { return n>=0?`+ ${n}`:`- ${Math.abs(n)}`; }
        function fmtX(n) { return Math.abs(n)===1?(n<0?'-':''):n; }
        function htmlW(t,v) { 
            let c = v >= 0 ? 'bg-blue' : 'bg-red'; let size='size-1';
            if(t==='x'){ if(Math.abs(v)>=3)size='size-2'; if(Math.abs(v)>=6)size='size-3'; let txt = Math.abs(v)===1 ? (v<0?'-x':'x') : `${v}x`; return `<div class="box-x ${c} ${size}">${txt}</div>`; } 
            else { let txt = v >= 0 ? `+${v}` : `${v}`; return `<div class="weight ${c}">${txt}</div>`; }
        }
        
        function useCheat(){ 
            if(state.isBusy) return; 
            if(state.integrity <= 0) {
                alert("ƒêi·ªÉm Li√™m ch√≠nh c·ªßa em hi·ªán b·∫±ng kh√¥ng n√™n s·∫Ω kh√¥ng ƒë∆∞·ª£c H·ªá th·ªëng Ph√°p l√Ω h·ªó tr·ª£ em n·ªØa! Em h√£y t·ª± xoay s·ªü nh√©!");
                return;
            }
            state.integrity=Math.max(0,state.integrity-20); document.getElementById('int-disp').innerText=state.integrity; 
            document.getElementById('cheat-val').innerText=`x = ${state.q.x}`; 
            const m=document.getElementById('cheat-modal'); m.style.display='flex'; setTimeout(()=>m.style.opacity=1,50); 
        }
        function closeCheat(){ const m=document.getElementById('cheat-modal'); m.style.opacity=0; setTimeout(()=>m.style.display='none',300); }
        
        // --- CHATBOT ---
        const botKnowledge = {
            "th·∫ßy th√¥ng": "Th·∫ßy Th√¥ng c√≥ t√™n ƒë·∫ßy ƒë·ªß l√† V√µ B√πi Duy Th√¥ng, sinh ng√†y 22/02/1986, qu√™ ·ªü B√¨nh Thu·∫≠n nay g·ªçi l√† L√¢m ƒê·ªìng, t·ªët nghi·ªáp tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ ph·∫°m To√°n Th√†nh Ph·ªë H·ªì Ch√≠ Minh. Hi·ªán th·∫ßy c√≥ h∆°n 15 nƒÉm kinh nghi·ªám d·∫°y to√°n b·∫≠c ph·ªï th√¥ng v√† ch·ªß nhi·ªám l·ªõp t·∫°i c√°c tr∆∞·ªùng T∆∞ th·ª•c v√† Qu·ªëc t·∫ø song ng·ªØ. Th·∫ßy ƒëam m√™ nghi√™n c·ª©u AI, ƒë·ªïi m·ªõi ph∆∞∆°ng ph√°p d·∫°y h·ªçc v√† qu·∫£n l√Ω l·ªõp h·ªçc. Th·∫ßy c≈©ng th√≠ch d·∫°y To√°n b·∫±ng ti·∫øng Anh. Th·∫ßy kh√¥ng th√≠ch chuy·ªán bao ƒë·ªìng v√† xen v√†o vi·ªác ri√™ng c·ªßa ng∆∞·ªùi kh√°c.",
            "ti·ªÉu s·ª≠": "Th·∫ßy V√µ B√πi Duy Th√¥ng sinh ng√†y 22/02/1986, t·ªët nghi·ªáp ƒêH S∆∞ ph·∫°m TP.HCM. Th·∫ßy c√≥ h∆°n 15 nƒÉm kinh nghi·ªám.",
            "s·ªë nguy√™n": "S·ªë nguy√™n bao g·ªìm c√°c s·ªë nguy√™n d∆∞∆°ng (1, 2, 3...), s·ªë 0 v√† c√°c s·ªë nguy√™n √¢m (-1, -2, -3...).",
            "t√¨m x": "Nguy√™n t·∫Øc v√†ng: Chuy·ªÉn v·∫ø $\\rightarrow$ ƒê·ªïi d·∫•u.",
            "ƒë·∫°o ƒë·ª©c": "Li√™m ch√≠nh l√† l√†m ƒëi·ªÅu ƒë√∫ng ngay c·∫£ khi kh√¥ng ai nh√¨n th·∫•y.",
            "ng·ª• ng√¥n": "C·∫≠u b√© chƒÉn c·ª´u, R√πa v√† Th·ªè l√† nh·ªØng b√†i h·ªçc tuy·ªát v·ªùi v·ªÅ s·ª± trung th·ª±c v√† ki√™n tr√¨.",
            "li√™m ch√≠nh": "Li√™m ch√≠nh l√† s·ª± trong s·∫°ch, ngay th·∫≥ng. Trong tr√≤ ch∆°i n√†y, n√≥ th·ªÉ hi·ªán qua vi·ªác em t·ª± l·ª±c c√°nh sinh."
        };

        function toggleChat() { const w=document.getElementById('chat-window'); w.style.display = w.style.display==='flex'?'none':'flex'; }
        
        function sendMessage() { 
            const i=document.getElementById('chat-input'), t=i.value.trim(), b=document.getElementById('chat-body'); 
            if(!t)return; 
            b.innerHTML+=`<div class="msg user">${t}</div>`; i.value=''; b.scrollTop=b.scrollHeight;
            
            setTimeout(()=>{ 
                let r="Th·∫ßy khuy√™n: H√£y b√¨nh tƒ©nh v√† ƒë·ªçc k·ªπ ƒë·ªÅ."; 
                const lowerT = t.toLowerCase();
                
                if(lowerT.includes("sai") || lowerT.includes("l·ªói") || lowerT.includes("gi√∫p") || lowerT.includes("t·∫°i sao")) {
                    if(state.lastDetailedError) {
                        r = state.lastDetailedError;
                    } else if (state.lastResult === false) {
                         r = "Em v·ª´a l√†m sai c√¢u tr∆∞·ªõc ƒë√≥. H√£y xem k·ªπ ph·∫ßn gi·∫£i th√≠ch nh√©.";
                    } else {
                        r = "Hi·ªán t·∫°i em ƒëang l√†m r·∫•t t·ªët, ch∆∞a c√≥ l·ªói sai n√†o g·∫ßn ƒë√¢y c·∫ßn ph√¢n t√≠ch.";
                    }
                }
                else {
                    let found = false;
                    for (const k in botKnowledge) { if (lowerT.includes(k)) { r = botKnowledge[k]; found=true; break; } }
                    
                    if(!found) {
                        // Algebra Logic
                        if (lowerT.match(/^(\-?\d*)x\s*([\+\-])\s*(\-?\d*)x$/i)) {
                             const match = lowerT.match(/^(\-?\d*)x\s*([\+\-])\s*(\-?\d*)x$/i);
                             let a = match[1]; if(a==='' || a==='+') a=1; else if(a==='-') a=-1; else a=parseInt(a);
                             let op = match[2];
                             let b = match[3]; if(b==='' || b==='+') b=1; else if(b==='-') b=-1; else b=parseInt(b);
                             let res = (op === '+') ? (a+b) : (a-b);
                             r = `K·∫øt qu·∫£ r√∫t g·ªçn: ${res}x`;
                        }
                        // Date/Time Math Logic
                        else if (lowerT.includes("h√¥m nay") || lowerT.includes("b√¢y gi·ªù")) {
                            const now = new Date();
                            r = `B√¢y gi·ªù l√†: ${now.toLocaleTimeString()} ng√†y ${now.toLocaleDateString('vi-VN')}.`;
                        } 
                        else if (lowerT.includes("ng√†y n·ªØa")) {
                            const now = new Date();
                            const match = lowerT.match(/(\d+)\s+ng√†y n·ªØa/);
                            if (match) {
                                const days = parseInt(match[1]);
                                const future = new Date(); future.setDate(now.getDate() + days);
                                r = `${days} ng√†y n·ªØa s·∫Ω l√† th·ª© ${future.getDay()===0?'Ch·ªß Nh·∫≠t': 'Hai,Ba,T∆∞,NƒÉm,S√°u,B·∫£y'.split(',')[future.getDay()-1]}, ng√†y ${future.toLocaleDateString('vi-VN')}.`;
                            }
                        }
                         // Math Check
                        else if (/^[\d\s\+\-\*\/\(\)\.]+$/.test(t)) {
                            try { r = `K·∫øt qu·∫£: ${new Function('return ' + t)()}`; } catch(e){}
                        }
                    }
                }
                
                b.innerHTML+=`<div class="msg bot">${renderMath(r)}</div>`; b.scrollTop=b.scrollHeight; 
            },500); 
        }
        
        function toggleAllAnswers() { document.querySelectorAll('.hw-answer').forEach(a=>a.classList.toggle('show')); }
        function downloadReport() { const r=document.getElementById('printable-report'), b=document.getElementById('download-btn'), h=r.style.height; b.innerText="‚è≥..."; r.style.height='auto'; r.style.overflow='visible'; html2canvas(r,{scale:2}).then(c=>{ r.style.height=h; r.style.overflow='hidden'; b.innerText="üì∏ L∆ØU PHI·∫æU ƒêI·ªÇM"; const l=document.createElement('a'); l.download=`Diem_${Date.now()}.png`; l.href=c.toDataURL(); l.click(); }); }
    </script>
</body>
</html>